FROM {{ os_name }}:{{ os_version }}

LABEL tailor="environment"

SHELL ["/bin/bash", "-c"]

ARG AWS_ACCESS_KEY_ID
ARG AWS_SECRET_ACCESS_KEY
ARG UNION_BUILD_DEPENDS
ARG UNION_RUN_DEPENDS
ARG APT_REFRESH_KEY

ENV AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID} \
    AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}

ENV DEBIAN_FRONTEND=noninteractive \
    LANG=en_US.UTF-8 \
    PYTHONUNBUFFERED=1 \
    ROS_HOME=/home/tailor/.ros

RUN echo "APT refresh key=${APT_REFRESH_KEY}"
RUN sed -i 's/archive.ubuntu.com/us-east-1.ec2.&/g' /etc/apt/sources.list && \
    apt-get update && \
    apt-get install --no-install-recommends -y \
    build-essential \
    ninja-build \
    unzip \
    locales \
    curl \
    gnupg \
    sudo \
    ccache \
    lld \
    software-properties-common \
    expect \
    apt-transport-https \
    apt-transport-s3 \
    vim \
    python3-venv \
    python3-pip \
    python3-apt \
    git \
    bzip2 && \
    locale-gen en_US.UTF-8 && \
    ccache -M 5G && \
    ccache --set-config=cache_dir=/ccache && \
    rm -rf /var/lib/apt/lists/*

# Create auth config file for accesing s3 via apt
RUN echo "AccessKeyId = $AWS_ACCESS_KEY_ID" | tee /etc/apt/s3auth.conf && \
    echo "SecretAccessKey = $AWS_SECRET_ACCESS_KEY" | tee -a /etc/apt/s3auth.conf && \
    echo "Token = ''" | tee -a /etc/apt/s3auth.conf && \
    echo "Region = '{{ bucket_region }}'" | tee -a /etc/apt/s3auth.conf

# Add package mirror
# TODO(pbovbel) read this from configuration
RUN curl -fsSL "https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x142D5F1683E1528B" \
      | gpg --dearmor -o /etc/apt/trusted.gpg.d/tailor.gpg && \
    echo "deb [arch=amd64] s3://{{ bucket_name }}/{{ release_label }}/ubuntu {{ os_version }}-mirror {{ os_version }}" >> /etc/apt/sources.list && \
    apt-get update && apt-get dist-upgrade -y && \
    apt-get install --no-install-recommends -y \
    python3-colcon-common-extensions && \
    rm -rf /var/lib/apt/lists/*

RUN curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip" \
 && unzip awscliv2.zip \
 && ./aws/install \
 && rm -rf awscliv2.zip aws

RUN echo "Checking whether S3 APT repo is initialized..."; \
    if aws s3api head-object \
        --bucket "{{ bucket_name }}" \
        --key    "{{ release_label }}/ubuntu/dists/{{ os_version }}/InRelease" \
        >/dev/null 2>&1; then \
      echo "deb [arch=amd64] s3://{{ bucket_name }}/{{ release_label }}/ubuntu {{ os_version }} main" >> /etc/apt/sources.list; \
    else \
      echo "Package repo not yet created, continuing"; \
    fi

# Install build and run dependencies
# TODO(pbovbel) install contrainted versions of packages rather than using 'regex_replace'
RUN apt-get update && RTI_NC_LICENSE_ACCEPTED=yes apt-get install --no-install-recommends -y \
  ${UNION_BUILD_DEPENDS} ${UNION_RUN_DEPENDS} && \
  rm -rf /var/lib/apt/lists/*

# Create venv
RUN python3 -m venv --system-site-packages /opt/tailor_venv
ENV VIRTUAL_ENV=/opt/tailor_venv
ENV PATH="$VIRTUAL_ENV/bin:$PATH"

COPY tailor-distro tailor-distro
RUN pip3 install -e tailor-distro
RUN pip3 install rospkg

RUN /opt/tailor_venv/bin/python -m pip install --ignore-installed --no-deps colcon-core colcon-clean
RUN /opt/tailor_venv/bin/python -m pip install colcon-common-extensions \
    "git+https://github.com/ruffsl/colcon-cache.git" rospkg
RUN ln -sf /opt/tailor_venv/bin/colcon /usr/local/bin/colcon

# Install restic
ARG RESTIC_VERSION=0.18.1
RUN curl -L "https://github.com/restic/restic/releases/download/v${RESTIC_VERSION}/restic_${RESTIC_VERSION}_linux_amd64.bz2" \
    -o /tmp/restic.bz2; \
    bunzip2 /tmp/restic.bz2; \
    install -m 0755 /tmp/restic /usr/local/bin/restic; \
    rm /tmp/restic


ARG USER_NAME=tailor
# Rename or create tailor user
RUN if id "ubuntu" >/dev/null 2>&1; then \
        usermod -md "/home/$USER_NAME" -s /bin/bash -l "$USER_NAME" ubuntu; \
        groupmod -n "$USER_NAME" ubuntu ; \
        echo "$USER_NAME:$USER_NAME" | chpasswd ; \
    else \
        groupadd -r -g 1000 "$USER_NAME" ; \
        useradd -ms /bin/bash -g "$USER_NAME" -G sudo "$USER_NAME" ; \
        mkdir -p "/home/$USER_NAME" ; \
        usermod -d "/home/$USER_NAME" "$USER_NAME" ; \
    fi ; \
    echo "$USER_NAME ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers

USER $USER_NAME
# Set workdir
WORKDIR /home/$USER_NAME
RUN mkdir -p "$ROS_HOME"
